rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Users collection - authenticated users can read/write their own data
    match /users/{userId} {
      // Allow read/write for the user's own document
      allow read, write: if request.auth != null && request.auth.uid == userId;

      // Allow create for registration
      allow create: if request.auth != null && request.auth.uid == userId;

      // Admin functions (checked by app logic)
      allow read: if isAdmin();
      allow update: if isAdmin();
    }

    // Venues collection - public read, authenticated write for venue owners/managers
    match /venues/{venueId} {
      // Anyone can read venues (for browsing)
      allow read: if true;

      // Venue managers can update their venues
      allow write: if request.auth != null && request.auth.token.email in getVenueManagers();

      // Admin can manage all venues
      allow write: if isAdmin();
    }

    // Guest List Requests - users can CRUD their own, admin can read all
    match /guestListRequests/{requestId} {
      // Allow authenticated users to create requests
      allow create: if request.auth != null;

      // Users can read/update their own requests
      allow read, update: if request.auth != null && request.auth.uid == resource.data.userId;

      // Admin can read all requests
      allow read, update: if isAdmin();

      // Venue staff can read requests for their venues
      allow read: if request.auth != null && request.auth.uid in getVenueStaff(resource.data.venueId);
    }

    // Bookings - users manage their own bookings
    match /bookings/{bookingId} {
      allow create: if request.auth != null;
      allow read, update: if request.auth != null && request.auth.uid == resource.data.userId;
      allow read, update: if isAdmin();
      allow read: if request.auth != null && request.auth.uid in getVenueStaff(resource.data.venueId);
    }

    // Tickets - users manage their purchases, venues manage events
    match /tickets/{ticketId} {
      allow create: if request.auth != null;
      allow read, update: if request.auth != null && request.auth.uid == resource.data.userId;
      allow read, update: if isAdmin();
      allow read: if request.auth != null && request.auth.uid in getVenueStaff(resource.data.venueId);
    }

    // KYC Submissions - users can submit, admin can review
    match /kycSubmissions/{submissionId} {
      allow create: if request.auth != null && request.auth.uid == request.resource.data.userId;
      allow read, update: if request.auth != null && request.auth.uid == resource.data.userId;
      allow read, update: if isAdmin();
    }

    // Safety Events - logged by system, admin read-only
    match /safetyEvents/{eventId} {
      allow create: if true; // Allow writes from server-side functions
      allow read: if isAdmin();
    }

    // Helper functions
    function isAdmin() {
      return request.auth != null &&
             request.auth.token.admin == true;
    }

    function getVenueManagers() {
      // In a real implementation, this would query venue managers
      // For now, allow admin and test emails
      return ['admin@glist.app', 'test@example.com'];
    }

    function getVenueStaff(venueId) {
      // Would query venue staff collection
      // For now, allow admin access
      return isAdmin();
    }
  }
